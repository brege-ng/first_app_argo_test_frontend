# ------------------------------
# Stage 1: Builder
# ------------------------------
FROM node:22.14.0-alpine3.20 AS builder

WORKDIR /app

# Copier package.json et package-lock.json
COPY package*.json ./

# Installer toutes les dépendances (dev + prod)
RUN npm ci

# Copier le reste du projet
COPY . .

# Construire l'application Next.js
RUN npm run build

# ------------------------------
# Stage 2: Image finale prod
# ------------------------------
FROM node:22.14.0-alpine3.20 AS prod

WORKDIR /app

ENV NODE_ENV=production
ENV HOST=0.0.0.0
ENV PORT=3000

# Copier seulement les fichiers nécessaires pour prod
COPY package*.json ./

# Installer uniquement les dépendances prod
RUN npm ci --omit=dev

# Copier le build Next.js depuis le builder
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/next.config.js ./next.config.js

# Si tu as des fichiers statiques dans public, copier seulement si ça existe
# COPY --from=builder /app/public ./public

# Exposer le port
EXPOSE 3000

# Lancer l'application
CMD ["npm", "start"]






#FROM node:22.14.0

#ENV HOST='0.0.0.0'
#ENV PORT='3000'

#WORKDIR /app

#COPY package*.json ./

#RUN npm ci

#COPY . .

#RUN npm run build

#EXPOSE 3000

#CMD [ "npm", "start" ]
